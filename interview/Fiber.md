## Fiber 面试

### 1. 什么是 Fiber？

**Fiber 是**: 

- React 16 中新的**协调引擎**，它是一个**虚拟堆栈帧**，用于 -> **存储** -> 组件的 -> **调用信息**。
- 将 React 的 -> **调和过程** -> **分解为** -> **多个阶段的** -> **算法**，
  - 这样可以将 -> **创建、更新和删除的工作** -> **分解到** -> 多个小单元，从而将其 -> **分散到** -> **多个帧中**。

### 2. 为什么 React 16 使用 Fiber？

**React 16 使用 Fiber 的目的**：

- 是为了解决 -> **调和过程中的性能问题**。
- 在 React 15 中：
  - 调和过程是 -> **同步的**。
  - 如果 **组件树** 很大，可能会导致 -> **主线程被长时间占用，造成页面卡顿**。
  - 而 React 16 使用 Fiber 将 -> **调和过程** -> **分解为** -> **多个阶段**，可以将 -> **主线程的** -> **执行时间分片**。
    - 让 -> **浏览器** -> 在执行完 -> 每一个阶段后 -> 都有机会去处理 -> 其他任务，从而 **提高页面的性能**。

### 3. Fiber 的工作原理是什么？

**Fiber 的工作原理是**:

- 通过将 **调和过程** 分解为 **多个阶段**，然后通过 **循环遍历 Fiber 树** 来 **执行这些阶段**。
  - Fiber 树: 是一个 **虚拟堆栈帧**，用于存储组件的调用信息。
    - 堆栈帧: 是一个数据结构，用于存储函数的调用信息。
- 在每一个阶段，React 都会根据 **当前阶段的优先级** 来决定 **是否中断** -> **当前阶段的执行**，然后去 **执行更高优先级的任务**。
  - 阶段：是指调和过程中的一个步骤，比如创建、更新和删除。
- 这样可以让 React 在 **执行调和过程的同时**，也可以 **响应用户的交互事件**，从而 **提高页面的性能**。

### 4. Fiber 的优先级是如何实现的？

**Fiber 的优先级是**：

- 通过一个叫做 **Expiration Time 的字段**来实现的。
- 在 React 16 中，**每一个 Fiber 节点 -> 都有 -> 一个 Expiration Time 字段**，用来表示 -> 当前节点的 **过期时间**。
- 当一个节点的 **过期时间** -> 小于 -> 当前时间时，表示这个节点已经过期。
  - React 会 -> 根据节点的优先级 -> 来决定 -> 是否中断当前阶段的执行，然后去 -> 执行更高优先级的任务。
  - 举例：
  
```js
const root = {
  expirationTime: 10,
  child: {
    expirationTime: 5,
    sibling: {
      expirationTime: 15,
    },
  },
};

const currentTime = 10;

// 当前时间为 10，child 节点的过期时间为 5，表示 child 节点已经过期
// React 会根据节点的优先级来决定是否中断当前阶段的执行，然后去执行更高优先级的任务
```

### 5. Fiber 的调度是如何实现的？

**Fiber 的调度是**：

- 通过一个叫做 Scheduler 的模块来实现的。(/ˈskɛdʒʊlər/)
- Scheduler 模块负责 **调度任务的执行顺序**，它会根据 **任务的优先级** 来决定 **任务的执行顺序**。
- Scheduler 模块还会根据 **当前时间** 和 **任务的过期时间** 来决定 -> 是否中断 **当前任务的执行**，然后去执行更高优先级的任务。
    - 举例：

```js
const tasks = [
  { priority: 1, expirationTime: 10 },
  { priority: 2, expirationTime: 5 },
  { priority: 3, expirationTime: 15 },
];

const currentTime = 10;

// 当前时间为 10，第一个任务的过期时间为 10，第二个任务的过期时间为 5，第三个任务的过期时间为 15
// React 会根据任务的优先级和过期时间来决定是否中断当前任务的执行，然后去执行更高优先级的任务
```

### 6. Fiber 的中断和恢复是如何实现的？

**Fiber 的中断和恢复是**:

- 通过一个叫做 Suspense 的机制来实现的。(/səˈspens/)
- Suspense 机制可以让 React 在执行 **调和过程的同时**，也可以 **响应用户的交互事件**。
- 当一个任务被 **中断时**，React 会将 **中断的任务** -> 保存到 -> 一个叫做 Suspense List 的队列中，然后在 **下一个帧中** 恢复执行这些任务。

### 7. Fiber 的调和过程是如何实现的？

**Fiber 的调和过程是**：

- 通过一个叫做 Reconciler 的模块来实现的。
- Reconciler 模块负责遍历 Fiber 树，然后根据 -> 节点的类型和属性 -> 来执行**不同的操作**。
- 在执行 **调和过程** 的过程中，Reconciler 模块会 -> 根据节点的优先级 -> 来决定 -> 是否中断当前阶段的执行，然后去执行更高优先级的任务。

### 8. Fiber 的渲染过程是如何实现的？

**Fiber 的渲染过程是**:

- 通过一个叫做 Renderer 的模块来实现的。
- Renderer 模块负责将 Fiber 树转换为真实的 DOM 元素，并将其 **插入到页面中**。
- 在渲染过程中，Renderer 模块会 -> 根据节点的 **类型** 和 **属性** 来 **生成对应的 DOM 元素**，并将其插入到页面中。

### 9. Fiber 的更新过程是如何实现的？

**Fiber 的更新过程是**:

- 通过一个叫做 Updater 的模块来实现的。
- Updater 模块负责 -> 将**组件的状态** -> 更新到 -> Fiber 节点中，并 **触发** -> **调和过程的执行**。
- 在**更新过程中**，Updater 模块会 -> 根据组件的 **状态** 和 **属性** 来 -> **更新** -> 对应的 Fiber 节点，并 **触发** 调和过程的执行。

### 10. Fiber 的生命周期是如何实现的？

**Fiber 的生命周期是**:

- 通过一个叫做 Lifecycle 的模块来实现的。
- Lifecycle 模块负责 -> **管理组件的生命周期方法** -> 的执行顺序。
- 在生命周期过程中，Lifecycle 模块会根据 -> **组件的状态和属性** -> 来执行对应的 **生命周期方法**。

### 11. Fiber 的错误处理是如何实现的？

**Fiber 的错误处理是**:

- 通过一个叫做 Error Boundary 的机制来实现的。
- Error Boundary 机制可以 **捕获** -> 组件树 -> 中的错误，并将错误信息显示到页面上。
- 当一个组件发生错误时，React 会将 **错误信息** 传递给 Error Boundary 组件。
  - 然后 Error Boundary 组件会将 **错误信息** 显示到页面上。

### 12. Fiber 的性能优化是如何实现的？

**Fiber 的性能优化是**:

- 通过一些技术手段来实现的，比如 Memoization、Batching、Virtual DOM 等。
  - Memoization 技术: 可以 **缓存** 组件的计算结果，从而 **避免重复计算**。
  - Batching 技术: 可以 **将多个更新合并为一个更新**，从而 **减少渲染次数**。
  - Virtual DOM 技术: 可以将 **虚拟 DOM 树** 转换为 **真实的 DOM 树**，从而 **减少页面的重绘次数**。

### 13. Fiber 的未来发展方向是什么？

**Fiber 的未来发展方向是**:

- 继续优化性能，提高稳定性，增加新的特性。
- React 团队会继续改进 Fiber 的算法，优化 **调和过程的执行顺序**，提高页面的性能。
- React 团队还会增加新的特性，比如 Concurrent Mode、Suspense for Data Fetching 等，来提高用户体验。

### 14. Fiber 的局限性是什么？

**Fiber 的局限性是**:

- 在一些极端情况下可能会出现性能问题。
  - 比如当组件树很大，或者组件的 **更新频率很高时**，可能会导致 **页面卡顿**。
  - 此外，Fiber 的调和过程是异步的，可能会导致一些难以调试的问题。
  
> 因此，在使用 Fiber 时需要注意这些局限性，避免出现性能问题。

### 15. Fiber 的应用场景是什么？

**Fiber 的应用场景是**:

- 在需要 **高性能的页面** 中使用。
  - 比如在 **需要频繁更新的页面中**，或者在 **需要响应用户交互事件** 的页面中，可以使用 Fiber 来提高页面的性能。
- 此外，Fiber 还可以用于 **构建复杂的交互式组件**，比如:
  - 表单
  - 表格
  - 图表
  - 等，来提高用户体验。

### 16. 阿辉面试官：你一直在提到核心是 “调和过程”，什么是调和过程？（总结）

**调和过程** 是指 React 在 **更新组件树** 时，将 **新的组件树** 与 **旧的组件树** 进行 **比较**，然后根据 **差异** 来 **更新页面** 的过程。

- 调和过程是 React 的核心算法，它可以 **高效地更新页面**，并且可以 **减少页面的重绘次数**。
- 调和过程是通过 **Fiber 树** 来实现的，它将 **组件的调用信息** 存储在一个 **虚拟堆栈帧** 中，然后通过 **循环遍历 Fiber 树** 来执行 **调和过程**。
- 调和过程是 **异步的**，可以让 React 在 **执行调和过程的同时**，也可以 **响应用户的交互事件**，从而 **提高页面的性能**。
- 调和过程是通过 **Reconciler 模块** 来实现的，它负责遍历 Fiber 树，然后根据 **节点的类型和属性** 来执行 **不同的操作**。
- 调和过程是通过 **Updater 模块** 来触发的，它负责将 **组件的状态** 更新到 **Fiber 节点** 中，并触发 **调和过程的执行**。
- 调和过程是通过 **Renderer 模块** 来渲染的，它负责将 **Fiber 树** 转换为 **真实的 DOM 元素**，并将其插入到页面中。
- 调和过程是通过 **Lifecycle 模块** 来管理生命周期方法的执行顺序的，它会根据 **组件的状态和属性** 来执行对应的 **生命周期方法**。
- 调和过程是通过 **Error Boundary 机制** 来处理错误的，它可以捕获组件树中的错误，并将错误信息显示到页面上。
- 调和过程是通过 **Memoization、Batching、Virtual DOM 等技术** 来优化性能的，可以 **缓存组件的计算结果**，**合并多个更新**，**减少页面的重绘次数**。
- 调和过程是通过 **Concurrent Mode、Suspense for Data Fetching 等新特性** 来增加用户体验的，可以 **提高页面的性能**，**减少页面的卡顿**。
- 调和过程是通过 **Scheduler 模块** 来调度任务的执行顺序的，它会根据 **任务的优先级和过期时间** 来决定是否中断当前任务的执行，然后去执行更高优先级的任务。
- 调和过程是通过 **Suspense 机制** 来中断和恢复任务的执行的，它可以让 React 在执行调和过程的同时，也可以响应用户的交互事件。
- 调和过程是通过 **Fiber 树** 来实现的，它是一个虚拟堆栈帧，用于存储组件的调用信息，然后通过循环遍历 Fiber 树来执行调和过程。
- 调和过程是通过 **Expiration Time 字段** 来实现的，它用来表示当前节点的过期时间，当一个节点的过期时间小于当前时间时，表示这个节点已经过期。
- 调和过程是通过 **Suspense List 队列** 来保存中断的任务的，然后在下一个帧中恢复执行这些任务。

