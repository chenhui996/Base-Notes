# 从输入URL到页面渲染的完整流程

## 1. 输入 URL 并解析

- 当用户在浏览器地址栏输入 URL 并按下回车后，浏览器随即对 URL 进行解析。
- URL 通常由多个部分组成，包括：
  - **协议**：如 `http` 或 `https`，决定了通信的方式。
  - **主机名**：可以是 **域名** 或 **IP地址**。
  - **端口号**：默认为 80(HTTP) 或 443(HTTPS)。
  - **路径**：指定服务器上的资源位置（/）。
  - **查询参数**：以？开头，包含键值对参数。
  - **片段标识**：以#开头，用于页面内定位。
- 浏览器会根据不同的 URL 类型进行 **特殊处理**：
  - **IP地址**：浏览器会直接尝试与该 IP 建立连接。
  - **域名**：浏览器会启动 **DNS 解析流程** 来 **获取对应的 IP 地址**。
  - **非HTTP(S)的特殊协议（如 mailto:、file: 等）**:
    - 浏览器会 **直接执行** 对应的操作，比如 **打开邮件客户端** 或 **本地文件**。

## 2. DNS域名解析（这个过程大约需要 20~120ms（甚至更长））

- **适合面试的表达**：
  - DNS解析就是：浏览器把 **域名** 换成 **IP** 的过程。
  - 先查缓存。没有，再问DNS服务器。
  - 前端可以用 dns-prefetch 提前 **解析域名** 优化性能。

### 详细版

- 当浏览器遇到域名（如www.example.com），需要先通过 DNS 查询获取对应的 IP 地址，流程如下：

#### (1)缓存查询
  
- 浏览器会按照顺序检查缓存:
  - **浏览器缓存** -> **系统缓存（Hosts 文件）** -> **路由器缓存** -> **运营商 DNS 缓存**。
- 如果都没命中，才会去走 **DNS 查询**。

#### (2)DNS 查询流程

1. 递归查询：浏览器向 **本地 DNS 服务器（如8.8.8.8）** 发起请求。
2. 迭代查询：本地 DNS 服务器依次查询：
   1. 根域名服务器（.）
   2. 顶级域名服务器（.com）
   3. 权威 DNS 服务器（example.com）

> 最终返回 `www.example.com` 的 IP。

#### (3)前端相关的 DNS 优化

- **DNS Prefetching**：提前解析可能访问的域名。
- **HTTP/2 Server Push**：服务器可推送 DNS 记录，减少查询。
- **DoH（DNS over HTTPS）**：加密 DNS，防劫持（如 1.1.1.1）。

---

## 3. 建立 TCP 连接（三次握手）

- 在 DNS 解析获取到 IP 地址后，浏览器会通过 **TCP 三次握手** 与 **服务器** 建立 **可靠连接**。
- 这是 HTTP 请求的基础，确保双方都能 **正常收发数据**。

- **适合面试的表达**：

1. 客户端发 `SYN`
2. 服务器返回 `SYN + ACK`
3. 客户端再回复 `ACK`

### 三次握手流程（详细版）

#### 1. 客户端 -> 服务端

- 客户端 发送 `SYN=1`（同步）包。
  - 并随机生产一个 **初始序列号** `seq=x`，表示：“**我想建立连接，我的初始序号是x**”。

#### 2. 服务端 -> 客户端

- 服务端 回复 `SYN=1, ACK=1`，确认号`ack=x+1`。
  - 并生成自己的序列号`seq=y`，表示：“**收到你的请求了（x+1），我也要建立连接，我的序号是y**”

#### 3. 客户端 -> 服务端

- 客户端 发送 `ACK=1`，确认号 `ack=y+1`。
  - 表示：“**收到你的确认了（y+1），连接建立成功！**”

### 追问：为什么需要三次握手？

- **防止 历史 重复连接 初始化导致的资源浪费**
  - 注：如果是两次握手，服务器可能 **误处理** 旧的重复 SYN 请求。
  - 解释：
    - 客户端通过序列号（seq）匹配服务端的回复，只对最新的握手发送第三次ACK。
    - 服务端虽然会响应所有SYN，但只有被客户端确认的连接能建立成功，旧请求会因缺少ACK超时释放。
    - 这样既 **保证了时序**，又 **避免了资源浪费**。
- **同步双方的初始序列号**
  - 注：保证数据顺序。
- **确认双方的收发能力正常**
