# JavaScript ä¸­çš„ this

- åœ¨ JavaScript ä¸­ï¼š
  - `this` æ˜¯ä¸€ä¸ª **åŠ¨æ€ç»‘å®š** çš„å…³é”®å­—ï¼Œä»£è¡¨ **å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡çš„å¯¹è±¡**ã€‚
  - å€¼ **å–å†³äº å‡½æ•°çš„è°ƒç”¨æ–¹å¼**ï¼Œéå®šä¹‰ä½ç½®ã€‚
- ç†è§£ `this` é‡è¦ï¼Œä½“ç°åœºæ™¯ï¼š
  - **å¯¹è±¡æ–¹æ³•**
  - **å›è°ƒå‡½æ•°**
  - **äº‹ä»¶å¤„ç†**
  - **æ„é€ å‡½æ•°**
  - **ç®­å¤´å‡½æ•°**
  - ç­‰

## 1. this çš„ç»‘å®šè§„åˆ™

### 1.1 é»˜è®¤ç»‘å®šï¼ˆç‹¬ç«‹å‡½æ•°è°ƒç”¨ï¼‰

- **éä¸¥æ ¼æ¨¡å¼**ï¼Œ`this` æŒ‡å‘ **å…¨å±€å¯¹è±¡**ï¼ˆæµè§ˆå™¨ä¸­æ˜¯ windowï¼ŒNode.js ä¸­æ˜¯ globalï¼‰ã€‚
- **ä¸¥æ ¼æ¨¡å¼**ï¼Œ`this` ä¸º **undefined**ã€‚

- ç¤ºä¾‹ï¼š

```js
function show() {
  console.log(this); // éä¸¥æ ¼æ¨¡å¼ï¼šwindowï¼Œä¸¥æ ¼æ¨¡å¼ï¼šundefined
}

show();
```

### 1.2 éšå¼ç»‘å®šï¼ˆå¯¹è±¡æ–¹æ³•è°ƒç”¨ï¼‰

- **å‡½æ•° ä½œä¸ºå¯¹è±¡ çš„ æ–¹æ³• è°ƒç”¨æ—¶**ï¼Œthis æŒ‡å‘ -> **è°ƒç”¨è¯¥æ–¹æ³•çš„å¯¹è±¡**

- ç¤ºä¾‹ï¼š

```js
const obj = {
  name: "Alice",
  greet() {
    console.log(this.name); // this æŒ‡å‘ obj
  }
};

obj.greet(); // Alice
```

- æ³¨æ„ï¼šéšå¼ä¸¢å¤±

```js
const greetFn = obj.greet;
greetFn(); // âŒ undefinedï¼ˆå› ä¸º this ä¸¢å¤±ï¼‰
```

### 1.3 æ˜¾å¼ç»‘å®šï¼ˆcallã€applyã€bindï¼‰

- call å’Œ applyï¼šå¯ä»¥æŒ‡å®š thisï¼Œ**ç«‹å³è°ƒç”¨** å‡½æ•°ã€‚
- bindï¼šè¿”å›ä¸€ä¸ª **æ–°çš„å‡½æ•°**ï¼Œä¸ä¼šç«‹å³è°ƒç”¨ã€‚

> äºŒè€…å‡æ‰‹åŠ¨æŒ‡å®šäº† this

- ç¤ºä¾‹ï¼š

```js
function greet(){
    console.log(this.name);
}

const person = {name: 'Cain'};

greet.call(person); // Cain
greet.apply(person); // Cain

const boundGreet = greet.bind(person);
// éœ€æ‰‹åŠ¨è°ƒç”¨
boundGreet(); // Cain
```

- åŒºåˆ«ï¼š
  - call å’Œ apply çš„åŒºåˆ«åœ¨äº **å‚æ•°ä¼ é€’æ–¹å¼**ï¼š
    - call(thisArg, arg1, arg2, ...)
    - apply(thisArg, [arg1, arg2, ...])
  - è¿˜æœ‰ bindï¼š
    - bind(thisArg, arg1, arg2, ...)

### 1.4 new ç»‘å®šï¼ˆæ„é€ å‡½æ•°ï¼‰

- new å…³é”®è¯ åˆ›å»º æ–°å¯¹è±¡ï¼Œå¹¶å°† this ç»‘å®šåˆ°è¯¥ **æ–°å¯¹è±¡**ã€‚

- ç¤ºä¾‹ï¼š

```js
function Person(name){
    this.name = name;
}

const p = new Person('Cain');
console.log(p.name); // Cain

// this ç»‘å®šåˆ°äº† p
```

### 1.5 ç®­å¤´å‡½æ•°ç»‘å®šï¼ˆè¯æ³•ä½œç”¨åŸŸï¼‰

- ç®­å¤´å‡½æ•°ä¸ç»‘å®š thisï¼Œå®ƒçš„ this **ç»§æ‰¿ è‡ª å¤–éƒ¨ä½œç”¨åŸŸ**ã€‚

- ç¤ºä¾‹ï¼š

```js
const obj = {
    name: 'Cain',
    greet: () => {
        console.log(this.name); // âŒ this æŒ‡å‘å¤–éƒ¨ä½œç”¨åŸŸï¼ˆwindow / globalï¼‰
    }
}

obj.greet(); // undefined
```

- ç®­å¤´å‡½æ•°ä¸ä¼šåˆ›å»ºè‡ªå·±çš„ thisï¼Œä¼šç»§æ‰¿å®šä¹‰æ—¶çš„ thisã€‚

---

## é¢è¯•é¢˜

- æ¦‚å¿µé¢˜ï¼š

### 1. ä»€ä¹ˆæ˜¯ thisï¼Ÿå®ƒåœ¨ JavaScript ä¸­çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

- `this` æ˜¯ä»€ä¹ˆ:
  - åœ¨ JavaScript ä¸­ï¼Œ`this` æ˜¯ä¸€ä¸ª **åŠ¨æ€ç»‘å®š** çš„å…³é”®å­—ï¼Œä»£è¡¨ **å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡çš„å¯¹è±¡**ã€‚
  - `this` çš„å€¼ **å–å†³äº å‡½æ•°çš„è°ƒç”¨æ–¹å¼**ï¼Œéå®šä¹‰ä½ç½®ã€‚
- `this` çš„ä¸»è¦ä½œç”¨æ˜¯ï¼š
  - ç”±äºæŒ‡å‘çš„æ˜¯ **å½“å‰æ‰§è¡Œçš„ä¸Šä¸‹æ–‡å¯¹è±¡**ï¼Œä½¿å¾— **å‡½æ•°** èƒ½å¤Ÿ è®¿é—®å’Œæ“ä½œ **æ‰€å±å¯¹è±¡** çš„ **å±æ€§å’Œæ–¹æ³•**ã€‚

### 2. this åœ¨ä¸¥æ ¼æ¨¡å¼ ('use strict') ä¸‹çš„è¡Œä¸ºæ˜¯æ€æ ·çš„ï¼Ÿ

- **ç‹¬ç«‹è°ƒç”¨å‡½æ•°æ—¶**ï¼š
  - `this` ä¸º undefinedï¼ˆä¸å†æŒ‡å‘å…¨å±€å¯¹è±¡ï¼‰ã€‚
- **æ˜¾å¼ç»‘å®š**ï¼š
  - åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œè‹¥æ˜¾å¼ç»‘å®š call/apply ä¼ å…¥ null æˆ– undefinedï¼Œ`this` ä¼šæ›¿æ¢ä¸ºå…¨å±€å¯¹è±¡ã€‚
  - ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œ`this` ç›´æ¥æ¥å—ä¼ å…¥çš„å€¼ï¼ˆåŒ…æ‹¬ null æˆ– undefinedï¼‰
- **æ„é€ å‡½æ•°ï¼ˆnew ç»‘å®šï¼‰**ï¼š
  - æ„é€ å‡½æ•°å¿…é¡»é€šè¿‡ new è°ƒç”¨ï¼ˆå¦åˆ™æŠ¥é”™ï¼‰ã€‚ï¼ˆé¿å…æ„å¤–æ±¡æŸ“å…¨å±€å˜é‡

> å…¶ä»–è§„åˆ™ï¼ˆéšå¼ç»‘å®šã€ç®­å¤´å‡½æ•°ï¼‰ä¸éä¸¥æ ¼æ¨¡å¼ä¸€è‡´ã€‚

### ä¸ºä»€ä¹ˆ this åœ¨ setTimeout å›è°ƒä¸­é€šå¸¸æŒ‡å‘ windowï¼Ÿ

- åŸå› åœ¨äºå›è°ƒå‡½æ•°çš„è°ƒç”¨æ–¹å¼ã€‚
- å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ this çš„ **é»˜è®¤ç»‘å®šè§„åˆ™** å’Œ setTimeout çš„ **å·¥ä½œæœºåˆ¶æœ‰å…³**ã€‚
- ä»¥ä¸‹æ˜¯è¯¦ç»†è§£é‡Šï¼š

#### é»˜è®¤ç»‘å®šè§„åˆ™

- setTimeout çš„å›è°ƒå‡½æ•°ä¼šè¢«å½“ä½œä¸€ä¸ª **æ™®é€šå‡½æ•°ç‹¬ç«‹è°ƒç”¨**ï¼ˆè€Œä¸æ˜¯ä½œä¸ºå¯¹è±¡çš„æ–¹æ³•æˆ–é€šè¿‡æ˜¾å¼ç»‘å®šï¼‰ã€‚
- æ­¤æ—¶ï¼Œthis çš„æŒ‡å‘éµå¾ª **é»˜è®¤ç»‘å®šè§„åˆ™**ï¼š
  - éä¸¥æ ¼æ¨¡å¼ï¼šé»˜è®¤ç»‘å®šåˆ°å…¨å±€å¯¹è±¡ï¼ˆå¦‚ windowï¼‰ã€‚
  - ä¸¥æ ¼æ¨¡å¼ï¼šé»˜è®¤ç»‘å®šä¸º undefinedã€‚

#### setTimeout çš„æ‰§è¡Œæœºåˆ¶

- setTimeout çš„ **å›è°ƒå‡½æ•°** ä¼šè¢« æ¨å…¥ **äº‹ä»¶é˜Ÿåˆ—**ï¼Œç­‰å¾… **å½“å‰æ‰§è¡Œæ ˆ** æ¸…ç©ºåæ‰§è¡Œã€‚
- æ­¤æ—¶ï¼Œ**å›è°ƒå‡½æ•°** çš„ **è°ƒç”¨è€…** å®é™…ä¸Šæ˜¯ **å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡**ï¼Œè€Œé **æŸä¸ªå¯¹è±¡** æˆ– **æ˜¾å¼ç»‘å®š** çš„ä¸Šä¸‹æ–‡ã€‚
- å› æ­¤ï¼Œthis é»˜è®¤æŒ‡å‘å…¨å±€å¯¹è±¡ã€‚

#### å¸¸è§çš„è¯¯è§£åœºæ™¯

- å³ä½¿ **å›è°ƒå‡½æ•°** å®šä¹‰åœ¨ **å¯¹è±¡æ–¹æ³•å†…éƒ¨**ï¼ŒsetTimeout çš„å›è°ƒ -> ä»ä¼šä¸¢å¤±åŸå¯¹è±¡çš„ thisã€‚
- è¿™æ˜¯å› ä¸º:
  - å›è°ƒå‡½æ•°è¢«ç›´æ¥ä¼ é€’ç»™ setTimeoutï¼Œè€Œ **éé€šè¿‡å¯¹è±¡è°ƒç”¨**ã€‚

#### å¦‚ä½•è§£å†³ this æŒ‡å‘é—®é¢˜ï¼Ÿ

##### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ç®­å¤´å‡½æ•°

- **ç®­å¤´å‡½æ•°** æ²¡æœ‰è‡ªå·±çš„ `this`ï¼Œå®ƒä¼šç»§æ‰¿å¤–å±‚ä½œç”¨åŸŸçš„ `this`ã€‚

```js
const user = {
  name: "Alice",
  greet() {
    setTimeout(() => {
      console.log(this.name); // è¾“å‡º "Alice"ï¼ˆthis æŒ‡å‘ userï¼‰
    }, 1000);
  },
};

user.greet();
```

##### æ–¹æ³•äºŒï¼šæ˜¾å¼ç»‘å®š this

- é€šè¿‡ bindã€call æˆ– apply å¼ºåˆ¶ç»‘å®š thisã€‚

```js
const user = {
  name: "Alice",
  greet() {
    setTimeout(function() {
      console.log(this.name); // è¾“å‡º "Alice"
    }.bind(this), 1000); // å°†å¤–å±‚ this ç»‘å®šåˆ°å›è°ƒå‡½æ•°
  },
};
user.greet();
```

##### æ–¹æ³•ä¸‰ï¼šä¿å­˜ this åˆ°å˜é‡

- åˆ©ç”¨é—­åŒ…æ•è·å¤–å±‚ thisã€‚

```js
const user = {
  name: "Alice",
  greet() {
    const self = this; // ä¿å­˜ this
    setTimeout(function() {
      console.log(self.name); // è¾“å‡º "Alice"
    }, 1000);
  },
};
user.greet();
```

#### ä¸¥æ ¼æ¨¡å¼ä¸‹çš„è¡Œä¸º

- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸­ï¼Œç‹¬ç«‹è°ƒç”¨çš„å‡½æ•° this ä¸º undefinedï¼Œä½† setTimeout çš„å›è°ƒä»å¯èƒ½æŒ‡å‘å…¨å±€å¯¹è±¡ï¼ˆéƒ¨åˆ†ç¯å¢ƒå®ç°å·®å¼‚ï¼‰ã€‚
- ä¸è¿‡æ›´å®‰å…¨çš„åšæ³•æ˜¯æ˜¾å¼ç»‘å®šã€‚

### ç®­å¤´å‡½æ•°çš„ this ç»‘å®šæ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•å½±å“å®ƒçš„ä½¿ç”¨ï¼Ÿ

- **æ— è‡ªèº«çš„ this**:
  - ç®­å¤´å‡½æ•°æ²¡æœ‰è‡ªå·±çš„ this ç»‘å®šï¼Œå®ƒçš„ this **ç»§æ‰¿è‡ªå®šä¹‰æ—¶æ‰€åœ¨çš„å¤–å±‚ä½œç”¨åŸŸ**ï¼ˆå³æœ€è¿‘çš„éç®­å¤´å‡½æ•°ä½œç”¨åŸŸæˆ–å…¨å±€ä½œç”¨åŸŸï¼‰ã€‚
- **é™æ€ç»‘å®š**:
  - this åœ¨ **ç®­å¤´å‡½æ•°å®šä¹‰æ—¶ç¡®å®š**ï¼Œä¸”åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ **ä¸å¯æ›´æ”¹**ï¼ˆæ— æ³•é€šè¿‡ callã€applyã€bind æ˜¾å¼ä¿®æ”¹ï¼‰ã€‚
- **ä¸¥æ ¼æ¨¡å¼çš„å½±å“**:
  - å¦‚æœå¤–å±‚ä½œç”¨åŸŸå¤„äºä¸¥æ ¼æ¨¡å¼ï¼Œç®­å¤´å‡½æ•°çš„ this ä¼šç»§æ‰¿ä¸¥æ ¼æ¨¡å¼ä¸‹çš„å€¼ï¼ˆå¦‚ undefinedï¼‰ï¼›è‹¥å¤–å±‚æ˜¯éä¸¥æ ¼æ¨¡å¼ï¼Œåˆ™å¯èƒ½ç»§æ‰¿å…¨å±€å¯¹è±¡ã€‚

#### å¦‚ä½•æ­£ç¡®ä½¿ç”¨ï¼Ÿ

```js
const obj = {
  name: "Bob",
  greet() {
    const arrowFn = () => console.log(this.name); 
    // æ­¤æ—¶çš„thisï¼Œç»§æ‰¿è‡ª å¤–ä¾§æœ€è¿‘ ä¸” éç®­å¤´å‡½æ•° çš„ä½œç”¨åŸŸã€‚
    // ä¹Ÿå°±æ˜¯ greet çš„ thisï¼Œä¹Ÿå°±æ˜¯obj

    arrowFn(); // âœ… "Bob"ï¼Œå› ä¸º this ç»§æ‰¿è‡ª obj
  }
};
obj.greet();
```

### this åœ¨ class æ–¹æ³•å’Œæ™®é€šå‡½æ•°ä¸­æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- class å†…éƒ¨çš„æ–¹æ³•é»˜è®¤ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œå³ä½¿ä¸å†™ "use strict"ã€‚
- class æ–¹æ³•ä¸­çš„ this é»˜è®¤æŒ‡å‘å½“å‰å®ä¾‹å¯¹è±¡ï¼Œä½†å¦‚æœæ–¹æ³•è¢«å•ç‹¬èµ‹å€¼ï¼Œä¼šä¸¢å¤± this ç»‘å®šã€‚

#### ç¤ºä¾‹ï¼ˆæ­£ç¡®çš„ this ç»‘å®šï¼‰

```js
class Person {
  constructor(name) {
    this.name = name;
  }
  greet() {
    console.log(this.name);
  }
}
const p = new Person("Charlie");
p.greet(); // âœ… "Charlie"
```
  
#### é”™è¯¯ç¤ºä¾‹ï¼ˆthis ä¸¢å¤±ï¼‰

```js
const greetFn = p.greet;
greetFn(); // âŒ undefinedï¼Œå› ä¸º `this` å˜æˆ `window`
```

#### è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ bind ç»‘å®š this

```js
const boundGreet = p.greet.bind(p);
boundGreet(); // âœ… "Charlie"
```

### bind() æ–¹æ³•ä¸ call() å’Œ apply() çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- ä½œç”¨:
  - callï¼šæ˜¾å¼ç»‘å®š this
  - applyï¼šæ˜¾å¼ç»‘å®š this
  - bindï¼šæ˜¾å¼ç»‘å®š this
- æ˜¯å¦ç«‹åˆ»è°ƒç”¨ï¼š
  - callï¼šç«‹å³
  - applyï¼šç«‹å³
  - bindï¼šä¸ç«‹å³
- å‚æ•°ï¼š
  - callï¼šé€—å·åˆ†éš”å‚æ•°
  - applyï¼šå‚æ•°æ•°ç»„
  - bindï¼šé€—å·åˆ†éš”å‚æ•°

### åœ¨ ES6 class ä¸­ï¼Œä¸ºä»€ä¹ˆå»ºè®®ä½¿ç”¨ç®­å¤´å‡½æ•°ä½œä¸ºç±»æ–¹æ³•ï¼Ÿ

- **æ™®é€šæ–¹æ³•** ä¼šåœ¨ æ–¹æ³• **è¢«æå– æˆ– ä½œä¸º å›è°ƒå‡½æ•° ä½¿ç”¨æ—¶**ï¼Œå¯èƒ½å¯¼è‡´ this ä¸¢å¤±ã€‚
- **ç®­å¤´å‡½æ•°** ä¸ä¼šåˆ›å»ºè‡ªå·±çš„ thisï¼Œå¯ä»¥ç›´æ¥è®¿é—® class å†…éƒ¨çš„ thisï¼Œé¿å… this ç»‘å®šä¸¢å¤±ã€‚

- âœ… ç¤ºä¾‹ï¼ˆä½¿ç”¨ç®­å¤´å‡½æ•°é¿å… this ä¸¢å¤±ï¼‰ï¼š

```js
class Counter {
  count = 0;
  increment = () => {
    console.log(this.count++);
  };
}

const counter = new Counter();
const fn = counter.increment;
fn(); // âœ… 0ï¼ˆthis ä»ç„¶æŒ‡å‘ counterï¼‰
```

- âŒ å¦‚æœç”¨æ™®é€šå‡½æ•°ï¼Œä¼šä¸¢å¤± thisï¼š

```js
class Counter {
  count = 0;
  increment() {
    console.log(this.count++);
  }
}
const counter = new Counter();
const fn = counter.increment;
fn(); // âŒ TypeError: Cannot read properties of undefined
```

- ğŸ“Œ ç»“è®ºï¼šåœ¨ React/å‰ç«¯å¼€å‘ä¸­ï¼Œå»ºè®® **ä½¿ç”¨ç®­å¤´å‡½æ•°ä½œä¸ºç±»æ–¹æ³•**ï¼Œ**é˜²æ­¢ this ä¸¢å¤±**ã€‚
