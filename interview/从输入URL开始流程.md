# 从输入URL开始建立前端知识体系

这篇文章全面介绍了: 从输入 URL 开始 -> 前端页面渲染完成 -> 整个知识体系。包括：

- **浏览器主要进程**
- **输入网址解析**
- **缓存机制**
- **DNS 域名解析**
- **TCP/IP 连接**
- **HTTP 请求及各版本特点**
- **服务器处理请求**
- **浏览器渲染页面**
- **断开连接等内容**
  
并对其中的 **关键概念** 和 **流程** 进行了详细阐述。

--- 

## 前置内容 浏览器主要进程

浏览器是多进程的，主要分为：

- **浏览器主进程**：只有一个，主要控制页面的 **创建**、**销毁**、**网络资源管理**、**下载** 等。
- **第三方插件进程**：每一种类型的插件对应一个进程，仅当使用该插件时才创建。
- **GPU进程**：最多一个，用于3D绘制等。
- **浏览器渲染进程(浏览器内核)**：每个Tab页对应一个进程，互不影响。
  - GUI渲染线程：负责渲染浏览器界面，解析HTML、CSS，构建DOM树和Render树，布局和绘制等。
  - JavaScript引擎线程：负责处理JavaScript脚本程序。
  - 事件触发线程：负责事件轮询，发送事件到事件队列中。
  - 定时触发器线程：setInterval与setTimeout所在的线程。
  - 异步http请求线程：处理XMLHttpRequest请求。

## 第一部分 输入网址并解析

这里我们只考虑输入的是一个 URL 结构字符串，如果是非 URL 结构的字符串，则会用 **浏览器默认的搜索引擎** 搜索该字符串。

### URL的组成

- URL 主要由 协议、主机、端口、路径、查询参数、锚点 **6** 部分组成！
  - **协议**：http、https、ftp、file 等。
  - **主机**：www.baidu.com、www.google.com 等。
  - **端口**：80、8080、443 等。
  - **路径**：/、/index.html、/images 等。
  - **查询参数**：?id=1&name=2 等。
  - **锚点**：#top、#bottom 等。

## 1. 解析 URL

输入URL后，浏览器会解析出 **协议、主机、端口、路径等** 信息，并构造一个HTTP请求。

- 浏览器发送请求前，根据 **请求头** 的 **expires** 和 **cache-control** 判断是否命中（包括是否过期）**强缓存** 策略，如果命中，直接从缓存获取资源，并**不会发送请求**。
  - 如果没有命中，则进入下一步。
- **没有命中** 强缓存规则，浏览器会 **发送请求**，根据 **请求头** 的 **If-Modified-Since** 和 **If-None-Match** 判断 **是否命中协商缓存**，如果命中，直接从缓存获取资源。
  - 如果没有命中，则进入下一步。
- 如果前两步都没有命中，则 **直接从服务端获取资源**。

### HSTS
- HSTS，HTTP Strict Transport Security，简单说就是强制客户端使用 HTTPS 访问页面。其原理就是：
  1. 在服务器响应头中添加 Strict-Transport-Security，可以设置 max-age。
  2. 用户访问时，服务器种下这个头。
  3. 下次如果使用 http 访问，只要 max-age 未过期，客户端会进行内部跳转，可以看到 307 Redirect Internel 的响应码。
  4. 变成 https 访问源服务器。
- 由于安全隐患，会 **使用 HSTS 强制客户端使用 HTTPS 访问页面**。
- 当你的网站均采用 HTTPS，并符合它的安全规范：
  - 就可以申请加入 HSTS 列表，之后用户不加 HTTPS 协议再去访问你的网站，浏览器都会定向到 HTTPS。
- 无论匹配到没有，都要开始 DNS 查询工作了。

### 浏览器缓存

- 强缓存就是 -> 向 **浏览器缓存** -> 查找该 **请求结果**，并根据该结果的 -> **缓存规则** 来决定 -> 是否使用该 **缓存结果** 的过程。
  - 强缓存又分为两种: 
    - **Expires**：
      - 版本：HTTP/1.0
      - 来源：存在于服务端返回的响应头中
      - 语法：Expires: Wed, 22 Nov 2019 08:41:00 GMT
      - 缺点：服务器的时间和浏览器的时间可能并不一致导致失效
    - **Cache-Control**：
      - 版本：HTTP/1.1
      - 来源：响应头和请求头
      - 语法：Cache-Control:max-age=3600
      - 缺点：时间最终还是会失效
- 协商缓存就是 -> 浏览器携带缓存标识 -> 向服务器发送请求 -> 由服务器根据 -> **缓存标识** 和 -> **资源的最新修改时间** 来决定 -> 返回新资源还是 -> 返回304和继续使用缓存的过程。
  - 协商缓存又分为两种：
    - **Last-Modified**：
      - 版本：HTTP/1.0
      - 来源：存在于服务端返回的响应头中
      - 语法：Last-Modified: Wed, 22 Nov 2019 08:41:00 GMT
      - 缺点：如果文件被修改，但内容并没有改变，还是会重新请求
    - **ETag**：
      - 版本：HTTP/1.1
      - 来源：存在于服务端返回的响应头中
      - 语法：ETag: "5d8f8a8f-2a4d"
      - 优点：文件有任何改动，ETag就会重新生成，可以更精确的控制缓存
- 流程：
  - **用户请求资源** -> 浏览器先检查 **是否存在缓存**：
    - 存在缓存 -> 判断 **Expires** 和 **Cache-Control** 是否过期：
      - 未过期 -> 直接读取，并使用缓存。
      - 过期 -> 携带 **If-None-Match** 和 **If-Modified-Since** 向服务器发送请求，服务器判断是否命中 **协商缓存**，也就是判断 **资源是否有更新**。
        - 有更新 -> 返回新资源，并更新缓存。
        - 无更新 -> 返回 304，继续使用缓存。
    - 不存在缓存 -> 直接向服务器发送请求，获取资源 -> 缓存标识，存入缓存。
- 请求头：
  - no-cache：告知(代理)服务器不直接使用缓存，要求向原服务器发起请求。
  - no-store：所有内容都不会被保存到缓存或Internet临时文件中。
  - max-age=delta-seconds：告知服务器客户端希望接收一个存在时间不大于delta-secconds秒的资源。
  - max-stale[=delta-seconds]：告知(代理)服务器客户端愿意接收一个超过缓存时间的资源，若有定义delta-seconds则为delta-seconds秒，若没有则为任意超出时间。
  - min-fresh=delta-seconds：告知(代理)服务器客户端希望接收一个在小于delta-seconds秒内被更新过的资源。
  - no-transform：告知(代理)服务器客户端希望获取实体数据没有被转换(比如压缩)过的资源。
  - noly-if-cached：告知(代理)服务器客户端希望获取缓存的内容(若有),而不用向原服务器发去请求。
  - cache-extension：自定义扩展值，若服务器不识别该值将被忽略掉。