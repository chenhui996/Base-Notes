# 组件 | Image

- 本篇将介绍 `<Image>` 组件，因为 **图片** 往往占据了 **网页大小** 很大一部分，**图片的优化** 可谓是重中之重。
- Image 组件也提供了非常多的 prop 和配置项，了解这些 prop 以及背后的原理有助于我们更加深入的使用 Image 组件，带来更好的用户体验。

> `<Image>` 组件实现了 **懒加载** 和 **根据设备尺寸自动调整图片大小**。

## 图片与 LCP

### 1. 图片占比

- 根据 Web Almanac 中的介绍，图片大小占典型网站页面大小的很大一部分。
- 根据统计，2021 年 6 月网站的总大小中位数是 2019 KB（移动端），其中 881 KB 是图像。
- 这比 HTML（30 KB），CSS（72 KB），JavaScript（461 KB）和字体（97 KB）的总和还要多。

- 在绝大多数页面上（70% 移动设备，80% 桌面），最有影响的就是图片。
- Largest Contentful Paint（最大内容绘制，简写：LCP） 是一种 Web 性能指标，可以标识首屏中最大的内容元素。
  - 大部分时候，该元素都有图片。

### 2. LCP 背景

- 考虑到 LCP 并不算是一个常为大家熟知的概念，所以我们单独介绍下 LCP:
  - 对于 Web 开发者而言，衡量网页主要内容的加载速度一直是一个挑战。
  - 传统我们会使用 load、DOMContentLoaded 等方法，但它们并不表示用户在屏幕上看到的内容的时间。
  - 而像 **首次内容渲染（FCP）**，如果页面有 loading 效果，那获取的时间也是不准确的。
  - 当然也有 **首次有效绘制（FMP）** 等指标，但是这些指标非常复杂，往往是错误的。所以也不能用来确定主要内容的加载时间。
  - 根据 W3C Web 性能工作组中的讨论和 Google 的研究:
    - 要衡量网页主要内容的加载时间，更为准确的方法是查看 **最大元素的呈现时间**。
    - **这就是 LCP**。

### 3. Largest Contentful Paint (LCP) 指标简介

- LCP 是一个衡量网页加载性能的指标，它报告的是：
  - **视口内可见** 的 **最大图片** 或 **文本块** 的 **呈现时间**，这个时间是从网页开始加载时算起的。

> 为了提供良好的用户体验，网站应尽力将 Largest Contentful Paint 设置为 2.5 秒或更短。

- 那么问题来了:
  - 页面往往是分阶段加载的，网页中最大元素可能是在不断变化的，LCP 是怎么计算出来的呢？

#### LCP 的计算方式

1. **限定元素类型：**
   - 浏览器不会考虑网页上的所有元素来计算 LCP，而是只关注一些最有可能是用户关注的元素类型。
   - 这些元素类型包括：
     - `<img>` 元素（图片）。
     - 包含文本节点或内嵌级别文本元素的块级元素，如 `<p>` 元素（段落文本）。
     - 自动播放的 `<video>` 元素的第一帧。
     - GIF 动画等动画图片格式的第一帧。
2. **跟踪最大内容元素：**
   - 浏览器在绘制完第一帧后，会立即记录一个 largest-contentful-paint 类型的 PerformanceEntry，用于标识当前最大的内容元素。
   - 在后续的每一帧渲染中，浏览器都会检查最大内容元素是否发生变化。如果发生变化，就会再分派一个新的 PerformanceEntry。
   - 简而言之，**浏览器在每一帧都会更新并标示出当前最大的内容元素**。
3. **用户交互停止报告：**
   - 当用户与页面发生交互（如点击、滚动或按键）时，浏览器会停止报告新的 PerformanceEntry。
   - 这是因为用户交互通常会改变向用户显示的内容，比如滚动操作会导致新的内容进入视口。
   - 一般来说，发出的最后一个 PerformanceEntry 的 startTime 值就是 LCP 值，即 **最大内容元素最终呈现的时间**。

- **总结：**
  - LCP 是一个衡量网页加载性能的指标，它关注视口内可见的最大图片或文本块的呈现时间。
  - 浏览器通过限定元素类型、跟踪每一帧的最大内容元素，并在用户交互时停止报告来计算 LCP。
  - 最终，发出的最后一个 PerformanceEntry 的 startTime 值就是 LCP 值。

## Image 组件

### 1. 功能特性

- 讲解 LCP，只是为了帮助大家认识到图片优化的重要性（毕竟最大内容元素往往是图片）。
- 回到 `<Image>` 组件上，Next.js 基于原生的 HTML `<img>` 元素，实现了这些 **优化功能**：
  - **尺寸优化：** 自动为每个设备提供正确尺寸的图片，也会使用现代图片格式如 WebP 和 AVIF。
  - **视觉稳定性：** 防止图片加载时发生布局偏移（Layout Shift）。
  - **更快的页面加载：** 图片只有在进入视口的时候才会加载，使用懒加载功能，并可选使用模糊占位符。
  - **灵活配置：** 按需进行图片调整，远程服务器上的图片也可以。

> 这些功能我们会在讲解组件 API 的时候一一涉及。

### 2. 基础使用

- 这是 `<Image>` 组件的使用示例，看起来如同使用正常的 img 元素一样：

```jsx
// app/page.js
import Image from 'next/image'
 
export default function Page() {
  return (
    <Imagew
      src="/profile.png"
      width={500}
      height={500}
      alt="Picture of the author"
    />
  )
}
```
