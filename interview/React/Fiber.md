# Fiber 面试

## 1. 什么是 Fiber？

**Fiber 是**:

- React 16 中新的**协调引擎**，它是一个**虚拟堆栈帧**，用于 -> **存储** -> 组件的 -> **调用信息**。
- 还将 React 的 -> **调和过程** -> **分解为** -> **多个阶段的** -> **算法**，
  - 从而将 -> **创建、更新和删除的工作** -> **分解成** -> 多个小单元，从而将其 -> **分散到** -> **多个帧中**。

## 2. 为什么 React 16 使用 Fiber？

**React 16 使用 Fiber 的目的**：

- 是为了解决 -> **调和过程中的性能问题**。
- 在 React 15 中：
  - 调和过程是 -> **同步的**。
  - 如果 **组件树** 很大，可能会导致 -> **主线程被长时间占用，造成页面卡顿**。
  - 而 React 16 使用 Fiber 将 -> **调和过程** -> **分解为** -> **多个阶段**，可以将 -> **主线程的** -> **执行时间分片**。
    - 让 -> **浏览器** -> 在执行完 -> 每一个阶段后 -> 都有机会去处理 -> 其他任务，从而 **提高页面的性能**。

> Fiber 的主要目标是优化调和过程，通过将其分解为多个阶段，可以灵活地管理任务优先级，从而使 React 更加高效。

## 3. Fiber 的工作原理是什么？

**Fiber 的工作原理是**:

- 通过将 **调和过程** 分解为 **多个阶段**，并为每个任务分配优先级，从而优化 React 的性能。
- 它会通过 **循环遍历 Fiber 树** 来 **执行这些阶段**。
- React 在执行 **渲染阶段** 时，会根据 **当前任务的优先级** 决定是否中断，从而处理 **更高优先级的任务**，比如 **用户交互事件**。
  - 这种机制让 React 在保证 -> **流畅用户体验**的同时，也能 **高效完成渲染任务**。

### Fiber 树

- 是一种特殊的 **数据结构**，保存了 **组件树** 的 **状态信息**，类似 **虚拟堆栈帧**，可以在 -> 任务中断时恢复执行。
- 每个节点（Fiber）不仅包含了组件的状态信息，还包含了关于如何 **执行和更新** 该组件的指令。

### 调和过程，分为 **渲染阶段** 和 **提交阶段**

- 调和过程被分解为多个阶段，主要包括渲染阶段（Render Phase）和提交阶段（Commit Phase）
  - 渲染阶段（可中断）：
    - 这个阶段是可中断的，React 会在这个阶段计算组件树的变化，并生成一个新的 Fiber 树（也称为“工作树”或“镜像树”）。
    - React 可能会根据任务的优先级中断和恢复这个阶段的工作，以处理更高优先级的任务。
  - 提交阶段（不可中断）：
    - 这个阶段是不可中断的，React 会在这个阶段将新的 Fiber 树的变化应用到 DOM 上，导致 UI 的实际更新。

## 4. Fiber 的优先级是如何实现的？

**Fiber 的优先级是**：

- 通过一个叫做 **Expiration Time 的字段**来实现的。
- 在 React 16 中，**每一个 Fiber 节点 -> 都有 -> 一个 Expiration Time 字段**，用来表示 -> 当前节点的 **过期时间**。
- 当一个节点的 **过期时间** -> 小于 -> 当前时间时，表示这个节点已经过期。
  - React 会 -> 根据节点的优先级 -> 来决定 -> 是否中断当前阶段的执行，然后去 -> 执行更高优先级的任务。
  - 举例：
  
```js
const root = {
  expirationTime: 10,
  child: {
    expirationTime: 5,
    sibling: {
      expirationTime: 15,
    },
  },
};

const currentTime = 10;

// 当前时间为 10，child 节点的过期时间为 5，表示 child 节点已经过期
// React 会根据节点的优先级来决定是否中断当前阶段的执行，然后去执行更高优先级的任务
```

## 5. Fiber 的调度是如何实现的？

**Fiber 的调度是**：

- 通过一个叫做 Scheduler 的模块来实现的。(/ˈskɛdʒʊlər/)
- Scheduler 模块负责 **调度任务的执行顺序**，它会根据 **任务的优先级** 来决定 **任务的执行顺序**。
- Scheduler 模块还会根据 **当前时间** 和 **任务的过期时间** 来决定 -> 是否中断 **当前任务的执行**，然后去执行更高优先级的任务。
  - 举例：

```js
const tasks = [
  { priority: 1, expirationTime: 10 },
  { priority: 2, expirationTime: 5 },
  { priority: 3, expirationTime: 15 },
];

const currentTime = 10;

// 当前时间为 10，第一个任务的过期时间为 10，第二个任务的过期时间为 5，第三个任务的过期时间为 15
// React 会根据任务的优先级和过期时间来决定是否中断当前任务的执行，然后去执行更高优先级的任务
```

## 6. Fiber 的中断和恢复是如何实现的？

**Fiber 的中断和恢复是**:

- 通过一个叫做 Suspense 的机制来实现的。(/səˈspens/)
- Suspense 机制可以让 React 在执行 **调和过程的同时**，也可以 **响应用户的交互事件**。
- 当一个任务被 **中断时**，React 会将 **中断的任务** -> 保存到 -> 一个叫做 Suspense List 的队列中，然后在 **下一个帧中** 恢复执行这些任务。

## 7. Fiber 的调和过程是如何实现的？

**Fiber 的调和过程是**：

- 通过一个叫做 Reconciler 的模块来实现的。
- Reconciler 模块负责遍历 Fiber 树，然后根据 -> 节点的类型和属性 -> 来执行**不同的操作**。
- 在执行 **调和过程** 的过程中，Reconciler 模块会 -> 根据节点的优先级 -> 来决定 -> 是否中断当前阶段的执行，然后去执行更高优先级的任务。

## 8. Fiber 的渲染过程是如何实现的？

**Fiber 的渲染过程是**:

- 通过一个叫做 Renderer 的模块来实现的。
- Renderer 模块负责将 Fiber 树转换为真实的 DOM 元素，并将其 **插入到页面中**。
- 在渲染过程中，Renderer 模块会 -> 根据节点的 **类型** 和 **属性** 来 **生成对应的 DOM 元素**，并将其插入到页面中。

## 9. Fiber 的更新过程是如何实现的？

**Fiber 的更新过程是**:

- 通过一个叫做 Updater 的模块来实现的。
- Updater 模块负责 -> 将**组件的状态** -> 更新到 -> Fiber 节点中，并 **触发** -> **调和过程的执行**。
- 在**更新过程中**，Updater 模块会 -> 根据组件的 **状态** 和 **属性** 来 -> **更新** -> 对应的 Fiber 节点，并 **触发** 调和过程的执行。

## 10. Fiber 的生命周期是如何实现的？

**Fiber 的生命周期是**:

- 通过一个叫做 Lifecycle 的模块来实现的。
- Lifecycle 模块负责 -> **管理组件的生命周期方法** -> 的执行顺序。
- 在生命周期过程中，Lifecycle 模块会根据 -> **组件的状态和属性** -> 来执行对应的 **生命周期方法**。

## 11. Fiber 的错误处理是如何实现的？

**Fiber 的错误处理是**:

- 通过一个叫做 Error Boundary 的机制来实现的。
- Error Boundary 机制可以 **捕获** -> 组件树 -> 中的错误，并将错误信息显示到页面上。
- 当一个组件发生错误时，React 会将 **错误信息** 传递给 Error Boundary 组件。
  - 然后 Error Boundary 组件会将 **错误信息** 显示到页面上。

## 12. Fiber 的性能优化是如何实现的？

**Fiber 的性能优化是**:

- 通过一些技术手段来实现的，比如 Memoization、Batching、Virtual DOM 等。
  - Memoization 技术: 可以 **缓存** 组件的计算结果，从而 **避免重复计算**。
  - Batching 技术: 可以 **将多个更新合并为一个更新**，从而 **减少渲染次数**。
  - Virtual DOM 技术: 可以将 **虚拟 DOM 树** 转换为 **真实的 DOM 树**，从而 **减少页面的重绘次数**。

## 13. Fiber 的未来发展方向是什么？

**Fiber 的未来发展方向是**:

- 继续优化性能，提高稳定性，增加新的特性。
- React 团队会继续改进 Fiber 的算法，优化 **调和过程的执行顺序**，提高页面的性能。
- React 团队还会增加新的特性，比如 Concurrent Mode、Suspense for Data Fetching 等，来提高用户体验。

## 14. Fiber 的局限性是什么？

- **Fiber 的局限性主要体现在以下几个方面**：
  - **性能问题**：在组件树庞大或更新频率高的场景中，调和任务的开销可能导致页面卡顿或丢帧。
  - **异步调和的调试复杂性**：状态更新的 **异步特性**，可能导致开发者难以 **精确地调试复杂交互逻辑**。
  - **任务竞争问题**：**调和任务**可能占用主线程资源，影响动画或其他实时任务的性能。
  - **内存和计算开销**：Fiber 树的维护增加了内存和计算成本，可能导致资源浪费。
- **应对这些局限性可以借助**：
  - 优化状态和组件的更新逻辑。
    - 使用 React.memo 或类似工具优化组件的渲染。
    - 避免不必要的状态更新，特别是在高频率更新的场景中。
  - 使用 React DevTools 或调试工具辅助分析性能问题。
  - 在 React 18 中利用 Concurrent Mode 等特性，合理安排任务优先级和执行时机。

## 15. Fiber 的应用场景是什么？

**Fiber 的应用场景是**:

- 在需要 **高性能的页面** 中使用。
  - 比如在 **需要频繁更新的页面中**，或者在 **需要响应用户交互事件** 的页面中，可以使用 Fiber 来提高页面的性能。
- 此外，Fiber 还可以用于 **构建复杂的交互式组件**，比如:
  - 表单
  - 表格
  - 图表
  - 等，来提高用户体验。

## 16. 阿辉面试官：你一直在提到核心是 “调和过程”，什么是调和过程？（总结）

**调和过程** 是指 React 在 **更新组件树** 时，将 **新的组件树** 与 **旧的组件树** 进行 **比较**，然后根据 **差异** 来 **更新页面** 的过程。

- 调和过程是 React 的核心算法，它可以 **高效地更新页面**，并且可以 **减少页面的重绘次数**。
- 调和过程是通过 **Fiber 树** 来实现的，它将 **组件的调用信息** 存储在一个 **虚拟堆栈帧** 中，然后通过 **循环遍历 Fiber 树** 来执行 **调和过程**。
- 调和过程是 **异步的**，可以让 React 在 **执行调和过程的同时**，也可以 **响应用户的交互事件**，从而 **提高页面的性能**。
- 调和过程是通过 **Reconciler 模块** 来实现的，它负责遍历 Fiber 树，然后根据 **节点的类型和属性** 来执行 **不同的操作**。
- 调和过程是通过 **Updater 模块** 来触发的，它负责将 **组件的状态** 更新到 **Fiber 节点** 中，并触发 **调和过程的执行**。
- 调和过程是通过 **Renderer 模块** 来渲染的，它负责将 **Fiber 树** 转换为 **真实的 DOM 元素**，并将其插入到页面中。
- 调和过程是通过 **Lifecycle 模块** 来管理生命周期方法的执行顺序的，它会根据 **组件的状态和属性** 来执行对应的 **生命周期方法**。
- 调和过程是通过 **Error Boundary 机制** 来处理错误的，它可以捕获组件树中的错误，并将错误信息显示到页面上。
- 调和过程是通过 **Memoization、Batching、Virtual DOM 等技术** 来优化性能的，可以 **缓存组件的计算结果**，**合并多个更新**，**减少页面的重绘次数**。
- 调和过程是通过 **Concurrent Mode、Suspense for Data Fetching 等新特性** 来增加用户体验的，可以 **提高页面的性能**，**减少页面的卡顿**。
- 调和过程是通过 **Scheduler 模块** 来调度任务的执行顺序的，它会根据 **任务的优先级和过期时间** 来决定是否中断当前任务的执行，然后去执行更高优先级的任务。
- 调和过程是通过 **Suspense 机制** 来中断和恢复任务的执行的，它可以让 React 在执行调和过程的同时，也可以响应用户的交互事件。
- 调和过程是通过 **Fiber 树** 来实现的，它是一个虚拟堆栈帧，用于存储组件的调用信息，然后通过循环遍历 Fiber 树来执行调和过程。
- 调和过程是通过 **Expiration Time 字段** 来实现的，它用来表示当前节点的过期时间，当一个节点的过期时间小于当前时间时，表示这个节点已经过期。
- 调和过程是通过 **Suspense List 队列** 来保存中断的任务的，然后在下一个帧中恢复执行这些任务。

### 总结

- Fiber 是 React 的协调（reconciliation）算法的一个重新实现，旨在使 UI 更新过程更加灵活和高效。以下是更详细的解释：
- Fiber 树：
  - Fiber 树确实是一种特殊的数据结构，它是组件树的镜像，但每个节点（Fiber）不仅包含了组件的状态信息，还包含了关于如何执行和更新该组件的指令。
  - 每个 Fiber 节点可以看作是一个工作单元（work unit），它代表了组件树中的一部分工作。
- 调和过程：
  - 调和过程被分解为多个阶段，主要包括渲染阶段（Render Phase）和提交阶段（Commit Phase）。
    - 渲染阶段：
      - 这个阶段是可中断的，React 会在这个阶段计算组件树的变化，并生成一个新的 Fiber 树（也称为“工作树”或“镜像树”）。
      - React 可能会根据任务的优先级中断和恢复这个阶段的工作，以处理更高优先级的任务。
    - 提交阶段：
      - 这个阶段是不可中断的，React 会在这个阶段将新的 Fiber 树的变化应用到 DOM 上，导致 UI 的实际更新。
- 优先级调度：
  - React 使用优先级调度机制来决定何时执行和中断任务。
  - 每个任务（如状态更新、用户事件处理等）都被赋予一个优先级。
  - 当有更高优先级的任务到来时，React 可以中断当前正在进行的低优先级任务，转而处理高优先级任务，以确保高优先级任务（如用户交互）能够得到快速响应。
- 循环遍历 Fiber 树：
  - React 使用一个称为“工作循环”（work loop）的机制来遍历 Fiber 树并执行每个 Fiber 节点的工作。
  - 在工作循环中，React 会检查是否有待处理的任务，并根据任务的优先级决定是继续处理当前任务还是切换到另一个任务。
- 中断和恢复：
  - Fiber 的一个关键特性是它能够中断和恢复任务的执行。这意味着 React 可以在任何时候暂停当前任务，并在稍后继续执行，而不会丢失任何状态或进度。
  - 这种中断和恢复的能力使得 React 能够更有效地管理时间和资源，尤其是在处理复杂或大量更新的情况下。

### 口语化 - React Fiber 里头的 “工作循环”（work loop）的机制

- 面试官，说到这个“工作循环”（work loop）啊，其实就是 React Fiber 里头的一个核心机制，用来处理那些更新任务的。
- 你想啊，React 应用一跑起来，就会有各种各样的更新任务，比如状态变了、用户点了按钮啥的。这些任务呢，都会被放到一个队列里头等着被处理。
- 然后啊，这个工作循环就开始工作了。它就像一个勤劳的小蜜蜂，不停地从队列里头拿任务出来做。但是呢，它不是一口气把所有任务都做完，而是做一会儿，歇一会儿，再看看有没有新的高优先级任务进来。
- 要是有新的高优先级任务呢，它就把手头的任务先放一放，去处理那个新的任务。等处理完了，再回来继续之前没做完的任务。
- 这个循环啊，会一直进行下去，直到所有的任务都被处理完。而且啊，因为它可以中断和恢复任务，所以就能保证那些重要的、用户直接感受到的任务能够优先被处理，让用户感觉应用特别流畅。
- 所以啊，这个工作循环就是 React Fiber 用来高效管理更新任务的一个好办法。
